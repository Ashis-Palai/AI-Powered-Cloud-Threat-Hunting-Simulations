title: AWS Runtime Post-Exploitation Followed by IAM and Cloud Resource Discovery
id: 6f9b2c1d-3b72-4a9c-8e91-aws-runtime-iam-discovery
status: experimental
description: >
  Detects post-exploitation activity in AWS where a compromised runtime
  workload executes discovery commands or accesses metadata endpoints,
  followed by anomalous IAM and cloud resource discovery using an assumed
  role. This rule correlates GuardDuty Runtime findings, GuardDuty IAM
  findings, and CloudTrail API activity within a short time window.

author: Cloud Threat Hunting / Purple Team
date: 2026-01-06
references:
  - https://attack.mitre.org/techniques/T1059/006/
  - https://attack.mitre.org/techniques/T1552/007/
  - https://attack.mitre.org/techniques/T1526/
  - https://attack.mitre.org/techniques/T1611/
  - https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types.html
  - https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-event-reference.html

logsource:
  product: aws
  service: cloud trail & GuradDuty(Runtime)

detection:
  runtime_execution:
    EventSource|contains:
      - guardduty
    FindingType|contains:
      - Runtime/ReverseShell
      - Runtime/SuspiciousCommand
      - Runtime/Metadata
      - Runtime/DockerSocket

  runtime_indicators:
    RuntimeDetails|contains:
      - python
      - sh
      - bash
      - whoami
      - passwd
      - metadata
      - docker.sock

  iam_discovery_guardduty:
    FindingType|contains:
      - Discovery:IAMUser/AnomalousBehavior

  cloudtrail_identity_usage:
    EventSource:
      - sts.amazonaws.com
      - iam.amazonaws.com
      - s3.amazonaws.com
    EventName:
      - GetCallerIdentity
      - SimulateCustomPolicy
      - ListBuckets

  non_human_identity:
    UserIdentityType:
      - AssumedRole

  timeframe: 10m

  condition: >
    runtime_execution
    and runtime_indicators
    and (
      iam_discovery_guardduty
      or cloudtrail_identity_usage
    )
    and non_human_identity

falsepositives:
  - Compromised but intentionally tested workloads (red team / security testing)
  - Highly privileged automation roles performing discovery during deployments
  - Incident response activity following an alert

level: critical

tags:
  - attack.execution
  - attack.command_and_control
  - attack.discovery
  - attack.credential_access
  - attack.privilege_escalation
  - attack.t1059.006
  - attack.t1071.001
  - attack.t1033
  - attack.t1082
  - attack.t1552.007
  - attack.t1526
  - attack.t1611
