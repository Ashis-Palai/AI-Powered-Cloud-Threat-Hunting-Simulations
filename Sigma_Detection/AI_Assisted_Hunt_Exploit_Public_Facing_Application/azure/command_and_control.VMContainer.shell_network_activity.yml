title: Azure VM / Container â€“ Shell-Initiated Network Activity Including C2 and Cloud Service Abuse
id: b7e8d2a1-5f91-4a8c-9f3e-shell-network-activity
status: experimental
description: >
  Detects command-and-control and post-exploitation network activity originating
  from an interactive shell or scripting interpreter on Azure virtual machines
  or containerized workloads. This includes external reverse shell connections
  as well as internal cloud service access such as Azure Instance Metadata
  Service (IMDS) and Azure Resource Manager (ARM) APIs, which are commonly abused
  after web application exploitation.

author: Cloud Threat Hunting / Purple Team
date: 2026-01-08

references:
  - https://attack.mitre.org/techniques/T1071/001/
  - https://attack.mitre.org/techniques/T1059/006/
  - https://attack.mitre.org/techniques/T1552/005/
  - https://attack.mitre.org/techniques/T1526/
  - https://learn.microsoft.com/microsoft-365/security/defender/advanced-hunting-devicenetworkevents

logsource:
  product: azure
  service: defender_for_endpoint
  category: network_connection

detection:

  # Network activity initiated by shells or scripting interpreters
  shell_or_interpreter_process:
    InitiatingProcessFileName:
      - sh
      - bash
      - dash
      - zsh
      - python
      - python3
      - perl
      - ruby
      - node
      - curl
      - wget

  # Parent-child chain indicating interactive shell control
  shell_parent_context:
    InitiatingProcessParentFileName:
      - sh
      - bash
      - python
      - python3
      - php-fpm
      - apache
      - nginx

  # External command-and-control style connections
  external_c2_indicators:
    ActionType: ConnectionSuccess
    Protocol: TCP
    RemoteIP|startswith:
      - "1."
      - "2."
      - "5."
      - "8."
      - "13."
      - "18."
      - "23."
      - "31."

  # Azure Instance Metadata Service access
  imds_access:
    RemoteIP:
      - "169.254.169.254"
      - "169.254.170.2"
    InitiatingProcessCommandLine|contains:
      - metadata
      - oauth2
      - identity

  # Azure control-plane API access from shell context
  azure_control_plane_access:
    RemoteUrl|contains:
      - management.azure.com
    InitiatingProcessCommandLine|contains:
      - Authorization:
      - Bearer
      - roleAssignments
      - subscriptions

  # Containerized or cloud workload context
  cloud_execution_context:
    AdditionalFields|contains:
      - Containerized
      - ManagedIdentity
      - AzureControlPlane

  condition: >
    shell_or_interpreter_process
    and shell_parent_context
    and cloud_execution_context
    and (
      external_c2_indicators
      or imds_access
      or azure_control_plane_access
    )

falsepositives:
  - Legitimate containerized workloads calling Azure APIs using managed identity
  - Automated configuration management or monitoring agents
  - Red team or penetration testing activity

level: critical

tags:
  - attack.command_and_control
  - attack.credential_access
  - attack.discovery
  - attack.t1071.001
  - attack.t1059.006
  - attack.t1552.005
  - attack.t1526
  - azure
  - container
  - vm
