title: Azure Managed Identity Abuse via Instance Metadata Service (IMDS)
id: 4d8a7c21-1b9e-4f3a-bc92-azure-imds-managed-identity-abuse
status: experimental
description: >
  Detects potential abuse of Azure Managed Identities via the Instance Metadata
  Service (IMDS). This rule identifies successful token issuance events originating
  from the IMDS endpoint, particularly when accessed using non-application user
  agents or from containerized or atypical workloads. Such activity is commonly
  observed after host or container compromise and enables attackers to access
  Azure control plane and data plane resources.

author: Cloud Threat Hunting / Purple Team
date: 2026-01-08

references:
  - https://attack.mitre.org/techniques/T1552/005/
  - https://attack.mitre.org/techniques/T1526/
  - https://learn.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview
  - https://learn.microsoft.com/azure/virtual-machines/instance-metadata-service

logsource:
  product: azure
  service: signinlogs
  category: managed_identity

detection:

  # Successful managed identity sign-in via IMDS
  imds_token_issued:
    Category: ManagedIdentitySignIn
    ResultType: Success
    ClientCredentialType: ManagedIdentity
    IPAddress:
      - "169.254.169.254"
      - "169.254.170.2"
    NetworkLocationDetails: AzureIMDS

  # Token audience commonly abused post-compromise
  high_value_resource_audience:
    ResourceIdentity|contains:
      - management.azure.com
      - storage.azure.com
      - vault.azure.net

  # Non-standard or attacker-style user agents
  suspicious_user_agent:
    UserAgent|contains:
      - curl
      - wget
      - httpclient
      - python
      - powershell

  # Context indicating non-interactive workload token harvesting
  suspicious_execution_context:
    AuthenticationProcessingDetails|contains:
      - container
      - workload
      - vm

  condition: >
    imds_token_issued
    and high_value_resource_audience
    and (
      suspicious_user_agent
      or suspicious_execution_context
    )

falsepositives:
  - Legitimate applications using managed identities with custom HTTP clients
  - Automation or bootstrap scripts requesting tokens at startup
  - Security tooling validating managed identity access

level: high

tags:
  - attack.credential_access
  - attack.discovery
  - attack.t1552.005
  - attack.t1526
  - azure
  - managed_identity
  - imds
