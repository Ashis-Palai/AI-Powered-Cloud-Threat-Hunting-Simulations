title: Azure Application Gateway WAF – Public-Facing Application Exploit Attempt
id: 3b2e8c91-0c7a-4f6a-9a12-initial-access-appgw-exploit
status: experimental
description: >
  Detects exploitation attempts against public-facing applications protected by
  Azure Application Gateway Web Application Firewall. The rule identifies
  malicious request patterns associated with initial access techniques such as
  file upload abuse, remote code execution, injection attacks, and API
  exploitation. These behaviors are commonly used to establish an initial
  foothold or deploy web shells on exposed applications.

author: Cloud Threat Hunting / Purple Team
date: 2026-01-08

references:
  - https://attack.mitre.org/techniques/T1190/
  - https://attack.mitre.org/techniques/T1505/003/
  - https://owasp.org/www-project-top-ten/
  - https://learn.microsoft.com/azure/application-gateway/application-gateway-web-application-firewall-overview
  - https://coreruleset.org/

logsource:
  product: azure
  service: applicationgateway

detection:

  # Core WAF detection – exploitation-class rule triggers
  waf_exploit_rules:
    category: ApplicationGatewayFirewallLog
    operationName: ApplicationGatewayFirewall
    ruleId|startswith:
      - "93xxxx"     # Application attack (RCE, file upload, PHP, Java, etc.)
      - "94xxxx"     # Injection attacks (SQLi, command injection, XSS)

  # Malicious intent reflected in WAF messages
  waf_attack_indicators:
    message|contains:
      - injection
      - remote code
      - command
      - file upload
      - webshell
      - exploit
    details.message|contains:
      - script
      - payload
      - shell
      - upload
      - execution

  # High-risk request targets commonly abused for initial access
  suspicious_request_uri:
    requestUri|contains:
      - upload
      - file
      - import
      - api
      - exec
      - cmd
      - shell
      - admin

  # Suspicious file types associated with web shell deployment
  suspicious_file_extensions:
    requestUri|endswith:
      - ".php"
      - ".phtml"
      - ".php5"
      - ".jsp"
      - ".jspx"
      - ".asp"
      - ".aspx"
      - ".exe"
      - ".dll"
      - ".sh"
      - ".py"

  # Action indicates detection or blocking by WAF
  waf_enforcement:
    action:
      - Detected
      - Blocked

  condition: >
    waf_exploit_rules
    and waf_enforcement
    and (
      waf_attack_indicators
      or suspicious_request_uri
      or suspicious_file_extensions
    )

falsepositives:
  - Legitimate security testing or vulnerability scanning
  - Red team or penetration testing activities
  - Misconfigured applications triggering WAF rules during development

level: high

tags:
  - attack.initial_access
  - attack.persistence
  - attack.t1190
  - attack.t1505.003
  - azure
  - web
  - waf
